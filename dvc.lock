schema: '2.0'
stages:
  compute_distances@train:
    cmd: python -m src.compute_semantic_distances --split train --specs-dir data/tiered_imagenet/specs
      --output-dir data/tiered_imagenet/distances &> data/tiered_imagenet/logs/compute_distances_train.out
    deps:
    - path: data/tiered_imagenet/specs/train.json
      md5: 9d6d63b44c4496c4eb2456169e303250
      size: 24626
    - path: data/tiered_imagenet/specs/wordnet.is_a.txt
      md5: 26d5d2bf0f43a269950ae5f551dfadbd
      size: 1517000
    - path: src/compute_semantic_distances.py
      md5: cfd151a1fdbef5b9967707bae3f2666d
      size: 1079
    outs:
    - path: data/tiered_imagenet/distances/train.csv
      md5: daecfc11832898acdea1ceb04bbae72c
      size: 2252160
    - path: data/tiered_imagenet/logs/compute_distances_train.out
      md5: 837a8aa9e0cf3218c7b19bc0f7f3cd95
      size: 22591
  train:
    cmd: python -m src.train --specs-dir data/tiered_imagenet/specs --distances-dir
      data/tiered_imagenet/distances --metrics-dir data/tiered_imagenet/metrics --tb-log-dir
      data/tiered_imagenet/tb_logs --output-model data/tiered_imagenet/models/trained_model.tar
      --n-epochs 150 --n-tasks-per-epoch 500 --n-way 5 --n-query 10 --n-shot 5 --sampler
      semantic --semantic-alpha 1.0 --semantic-strategy weibull --random-seed 2 --device
      cuda:3 &> data/tiered_imagenet/logs/train.out
    deps:
    - path: data/tiered_imagenet/distances/train.csv
      md5: daecfc11832898acdea1ceb04bbae72c
      size: 2252160
    - path: data/tiered_imagenet/specs/train.json
      md5: 9d6d63b44c4496c4eb2456169e303250
      size: 24626
    - path: data/tiered_imagenet/specs/val.json
      md5: 41bf011f930c7b07ea8eff4216f91ee3
      size: 6846
    - path: src/train.py
      md5: d80232a8788e1a7004c92ed8ad2f55bb
      size: 5314
    outs:
    - path: data/tiered_imagenet/logs/train.out
      md5: 58d540cf76a8d16f2f40759eed396531
      size: 7742498
    - path: data/tiered_imagenet/metrics/training_tasks.pkl
      md5: 2685e30a4574c1757b0568352f600e2d
      size: 38431955
    - path: data/tiered_imagenet/models/trained_model.tar
      md5: 7e2533f2748b2b0361f472f11750c299
      size: 44785233
    - path: data/tiered_imagenet/tb_logs
      md5: d457c3efc21e0b187706284430cffe1d.dir
      size: 28020
      nfiles: 1
  get_train_stats:
    cmd: python -m src.get_training_tasks_stats --training-tasks-record data/tiered_imagenet/metrics/training_tasks.pkl
      --distances-dir data/tiered_imagenet/distances --metrics-dir data/tiered_imagenet/metrics
      &> data/tiered_imagenet/logs/get_train_stats.out
    deps:
    - path: data/tiered_imagenet/distances/train.csv
      md5: daecfc11832898acdea1ceb04bbae72c
      size: 2252160
    - path: data/tiered_imagenet/metrics/training_tasks.pkl
      md5: 2685e30a4574c1757b0568352f600e2d
      size: 38431955
    - path: src/get_training_tasks_stats.py
      md5: a9d1a8424913224674a8bafe84d1d1df
      size: 1795
    outs:
    - path: data/tiered_imagenet/logs/get_train_stats.out
      md5: 2b07aa1e64fbb86342d7c3ba065e9c9b
      size: 264
    - path: data/tiered_imagenet/metrics/intra_training_task_distances.csv
      md5: 879b196ade2fe799c84a0c79c02355fa
      size: 3173752
    - path: data/tiered_imagenet/metrics/training_classes_biconfusion.png
      md5: e41100f2e952025a03b52a563d81ac88
      size: 72639
    - path: data/tiered_imagenet/metrics/training_classes_sampled_together.png
      md5: 1d5766d3a61f6639c747c29d5ac7f82b
      size: 103062
  compute_distances@test:
    cmd: python -m src.compute_semantic_distances --split test --specs-dir data/tiered_imagenet/specs
      --output-dir data/tiered_imagenet/distances &> data/tiered_imagenet/logs/compute_distances_test.out
    deps:
    - path: data/tiered_imagenet/specs/test.json
      md5: 5eae905f4cd9e59bc0f138d5e84e485a
      size: 11256
    - path: data/tiered_imagenet/specs/wordnet.is_a.txt
      md5: 26d5d2bf0f43a269950ae5f551dfadbd
      size: 1517000
    - path: src/compute_semantic_distances.py
      md5: cfd151a1fdbef5b9967707bae3f2666d
      size: 1079
    outs:
    - path: data/tiered_imagenet/distances/test.csv
      md5: 84de996abe3b91d74ae9599578a9fc90
      size: 467358
    - path: data/tiered_imagenet/logs/compute_distances_test.out
      md5: 1ab91578d5e176f57e1d7e26c7b92b46
      size: 9454
  create_testbed@5:
    cmd: python -m src.create_testbed --n-tasks 5000 --n-way 5 --n-query 10 --n-shot
      5 --distances-csv data/tiered_imagenet/distances/test.csv --specs-json data/tiered_imagenet/specs/test.json
      --out-file data/tiered_imagenet/testbeds/testbed_5_shot.csv &> data/tiered_imagenet/logs/create_testbed_5.out
    deps:
    - path: data/tiered_imagenet/distances/test.csv
      md5: 84de996abe3b91d74ae9599578a9fc90
      size: 467358
    - path: data/tiered_imagenet/specs/test.json
      md5: 5eae905f4cd9e59bc0f138d5e84e485a
      size: 11256
    - path: src/create_testbed.py
      md5: 961adae5ff6bc535ff5c1f6321e50007
      size: 9942
    outs:
    - path: data/tiered_imagenet/logs/create_testbed_5.out
      md5: 3a60fa02535ef2709e01a681bc52b36d
      size: 6712
    - path: data/tiered_imagenet/testbeds/testbed_5_shot.csv
      md5: dcdbfef577d631c048f744c91d9cc01e
      size: 16912160
    - path: data/tiered_imagenet/testbeds/testbed_5_shot_occ.png
      md5: dac8808888df5d729bcb4558eff50ecd
      size: 13638
    - path: data/tiered_imagenet/testbeds/testbed_5_shot_pv.png
      md5: 1f955edce5067da0838e3bc7d47ad2d6
      size: 17303
  evaluate:
    cmd: python -m src.evaluate --specs-dir data/tiered_imagenet/specs --testbed data/tiered_imagenet/testbeds/testbed_5_shot.csv
      --trained-model data/tiered_imagenet/models/trained_model.tar --output-dir data/tiered_imagenet/metrics
      --device cuda:3 &> data/tiered_imagenet/logs/evaluate.out
    deps:
    - path: data/tiered_imagenet/models/trained_model.tar
      md5: 7e2533f2748b2b0361f472f11750c299
      size: 44785233
    - path: data/tiered_imagenet/specs/test.json
      md5: 5eae905f4cd9e59bc0f138d5e84e485a
      size: 11256
    - path: data/tiered_imagenet/testbeds/testbed_5_shot.csv
      md5: dcdbfef577d631c048f744c91d9cc01e
      size: 16912160
    - path: src/evaluate.py
      md5: 88072965073b573d33296c414846a537
      size: 1760
    outs:
    - path: data/tiered_imagenet/logs/evaluate.out
      md5: 2eb1bc12b8b92ed946bf6ca156aafaf2
      size: 192807
    - path: data/tiered_imagenet/metrics/raw_results.csv
      md5: ce41b1d5c475ecc12347fa8633b57ec8
      size: 63531988
  compute_metrics:
    cmd: python -m src.compute_metrics --testbed data/tiered_imagenet/testbeds/testbed_5_shot.csv
      --metrics-dir data/tiered_imagenet/metrics &> data/tiered_imagenet/logs/compute_metrics.out
    deps:
    - path: data/tiered_imagenet/metrics/raw_results.csv
      md5: ce41b1d5c475ecc12347fa8633b57ec8
      size: 63531988
    - path: data/tiered_imagenet/testbeds/testbed_5_shot.csv
      md5: dcdbfef577d631c048f744c91d9cc01e
      size: 16912160
    - path: src/compute_metrics.py
      md5: c616e1d973448737fe5ed97e2bf9bec5
      size: 2422
    outs:
    - path: data/tiered_imagenet/logs/compute_metrics.out
      md5: 17493d99d9532922c6b571abcab200de
      size: 681
    - path: data/tiered_imagenet/metrics/accuracy_v_variance.png
      md5: 6e77d965fe1187a2c7c8bfff8098f464
      size: 56212
    - path: data/tiered_imagenet/metrics/evaluation_metrics.json
      md5: e2d4abd24bd58766e0bcc550d14b05e6
      size: 236
    - path: data/tiered_imagenet/metrics/task_performances.csv
      md5: 4a08f89ea2c364b811349a9b43ab88a7
      size: 138249
  create_testbed@1:
    cmd: python -m src.create_testbed --n-tasks 5000 --n-way 5 --n-query 10 --n-shot
      1 --distances-csv data/tiered_imagenet/distances/test.csv --specs-json data/tiered_imagenet/specs/test.json
      --out-file data/tiered_imagenet/testbeds/testbed_1_shot.csv &> data/tiered_imagenet/logs/create_testbed_1.out
    deps:
    - path: data/tiered_imagenet/distances/test.csv
      md5: 84de996abe3b91d74ae9599578a9fc90
      size: 467358
    - path: data/tiered_imagenet/specs/test.json
      md5: 5eae905f4cd9e59bc0f138d5e84e485a
      size: 11256
    - path: src/create_testbed.py
      md5: 961adae5ff6bc535ff5c1f6321e50007
      size: 9942
    outs:
    - path: data/tiered_imagenet/logs/create_testbed_1.out
      md5: 2346e97c9addb487d0d25fb9b68d1f5b
      size: 6852
    - path: data/tiered_imagenet/testbeds/testbed_1_shot.csv
      md5: 9923a9df3301ccdc89b7348eb3f219d6
      size: 12439289
    - path: data/tiered_imagenet/testbeds/testbed_1_shot_occ.png
      md5: dac8808888df5d729bcb4558eff50ecd
      size: 13638
    - path: data/tiered_imagenet/testbeds/testbed_1_shot_pv.png
      md5: 1f955edce5067da0838e3bc7d47ad2d6
      size: 17303
